# FaceSocial AI Redis Configuration - SECURE VERSION
# Optimized for AI services caching and session management

# Basic Configuration
bind 0.0.0.0
port 6379
protected-mode yes

# Security Configuration
# Password authentication - will be set via environment variable
# Use: redis-server --requirepass $REDIS_PASSWORD
# Or set via AUTH command after connection

# TLS/SSL Configuration (uncomment for production)
# tls-port 6380
# port 0
# tls-cert-file /etc/ssl/redis/redis.crt
# tls-key-file /etc/ssl/redis/redis.key
# tls-ca-cert-file /etc/ssl/redis/ca.crt

# Memory Management - Increased for AI workloads
maxmemory 512mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Persistence Configuration
appendonly yes
appendfilename "facesocial-appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# RDB Snapshots (backup) - Enhanced for production
save 900 1      # Save if at least 1 key changed in 900 seconds
save 300 10     # Save if at least 10 keys changed in 300 seconds  
save 60 10000   # Save if at least 10000 keys changed in 60 seconds
save 15 1000000 # Save if at least 1M keys changed in 15 seconds
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename facesocial-redis.rdb
dir /data
auto-aof-rewrite-min-size 64mb

# RDB Snapshots (backup)
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# Logging Configuration
loglevel notice
logfile /var/log/redis/facesocial-redis.log
syslog-enabled yes
syslog-ident facesocial-redis
syslog-facility local0

# Network & Performance
tcp-keepalive 300
timeout 60  # Increased from 0 for better connection management
tcp-backlog 511

# Enhanced Security
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG REDIS_CONFIG_CMD
rename-command SHUTDOWN REDIS_SHUTDOWN_CMD
rename-command EVAL ""
rename-command SCRIPT ""

# Disable dangerous commands in production
# rename-command KEYS ""

# Slow Log Configuration
slowlog-log-slower-than 5000  # Reduced threshold for AI workload monitoring
slowlog-max-len 256           # Increased for better debugging

# Client Management - Enhanced for AI workloads
maxclients 2000               # Increased for concurrent AI requests
client-query-buffer-limit 1gb # Allow larger queries for AI data

# Key Expiration Policies (optimized for AI cache)
# Face embeddings cache: 3600 seconds (1 hour)
# Session data: 1800 seconds (30 minutes)  
# Temporary analysis results: 300 seconds (5 minutes)
# API rate limiting: 86400 seconds (24 hours)

# Memory Optimization for AI Workloads
hash-max-ziplist-entries 1024  # Increased for face metadata
hash-max-ziplist-value 128     # Increased for embedding data
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 1024    # Increased for user sets
zset-max-ziplist-entries 256   # Increased for ranking data
zset-max-ziplist-value 128

# HyperLogLog Optimization
hll-sparse-max-bytes 3000

# Streams Configuration (for real-time AI events)
stream-node-max-bytes 8192    # Increased for AI event data
stream-node-max-entries 200   # Increased for better batching

# Active Rehashing
activerehashing yes

# Client Output Buffer Limits - Enhanced for AI workloads
client-output-buffer-limit normal 32mb 16mb 60      # Increased for AI responses
client-output-buffer-limit replica 512mb 128mb 60   # Increased for replication
client-output-buffer-limit pubsub 64mb 16mb 60      # Increased for real-time updates

# Threading Configuration (Redis 6.0+) - Optimized for AI workloads
io-threads 4                  # Enabled for better concurrency
io-threads-do-reads yes       # Enable threaded reads

# Lazy Freeing (non-blocking deletes)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Modules Configuration
# Future AI-specific modules can be loaded here
# loadmodule /opt/redis-modules/redis-ai.so
# loadmodule /opt/redis-modules/redis-timeseries.so

# Monitoring and Health Checks
latency-monitor-threshold 100  # Monitor operations > 100ms

# Database Configuration
databases 16  # Keep default 16 databases

# Key Space Notifications (for cache invalidation)
notify-keyspace-events "Ex"   # Enable expiration events
# loadmodule /path/to/module.so